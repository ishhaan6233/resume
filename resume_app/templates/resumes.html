{% extends "base.html" %} {% load static %} {% block title %}Resumes -
JobJourney{% endblock %} {% block content %}
<div class="page">
  <!-- Left Panel: Resume list -->
  <div class="left-panel">
    <h2>My Resumes</h2>
    <button class="create-btn" id="create-resume">+ Create Resume</button>

    <div id="resume-list"></div>
  </div>

  <div class="preview-panel" id="preview-panel"></div>

  <div id="resume-template" style="display: none">
    <div class="preview-header" contenteditable="true">
      <h2>Name</h2>
      <button id="download-pdf" data-html2canvas-ignore>
        â¬‡ Download as PDF
      </button>
    </div>
    <hr />
    <div class="contact" contenteditable="true">
      <span>(123) 456-7890</span>
      <span>example@example.com</span>
      <span>linkedin.com/in/username</span>
    </div>

    <!-- Sections -->
    <div class="section" id="summary">
      <div class="section-controls">
        <button class="move-up-btn">â¬†</button>
        <button class="move-down-btn">â¬‡</button>
      </div>
      <h3>Summary</h3>
      <div class="content" contenteditable="true">
        <p>Write a brief summary about yourself...</p>
      </div>
    </div>

    <div class="section" id="experience">
      <div class="section-controls">
        <button class="move-up-btn">â¬†</button>
        <button class="move-down-btn">â¬‡</button>
      </div>
      <h3>Experience</h3>
      <div class="content">
        <div class="job" contenteditable="true">
          <p class="job-title">Job title @ company</p>
          <p class="job-meta">Location | Date 1 - Date 2</p>
          <ul>
            <li>Describe responsibilities...</li>
          </ul>
          <button class="delete-job-btn">âœ–</button>
        </div>
      </div>
      <button class="add-job-btn">+ Add Job</button>
    </div>

    <!-- Education -->
    <div class="section" id="education">
      <div class="section-controls">
        <button class="move-up-btn">â¬†</button>
        <button class="move-down-btn">â¬‡</button>
      </div>
      <h3>Education</h3>
      <div class="content">
        <div class="education" contenteditable="true">
          <p class="degree">Degree, School</p>
          <p>Date 1 - Date 2</p>
          <button class="delete-education-btn">âœ–</button>
        </div>
      </div>
      <button class="add-education-btn">+ Add Education</button>
    </div>

    <!-- Skills -->
    <div class="section" id="skills">
      <div class="section-controls">
        <button class="move-up-btn">â¬†</button>
        <button class="move-down-btn">â¬‡</button>
      </div>
      <h3>Skills</h3>
      <div class="content skills-grid">
        <div class="skill-item" contenteditable="true">
          <p><strong>Category:</strong></p>
          <p>Skills</p>
          <button class="delete-skill-btn">âœ–</button>
        </div>
      </div>
      <button class="add-skill-btn">+ Add Skill</button>
    </div>

    <!-- Projects -->
    <div class="section" id="projects">
      <div class="section-controls">
        <button class="move-up-btn">â¬†</button>
        <button class="move-down-btn">â¬‡</button>
      </div>
      <h3>Projects</h3>
      <div class="content">
        <div class="project-item" contenteditable="true">
          <p>
            <strong>Project title:</strong>
          </p>
          <ul>
            <li>Bullet point</li>
          </ul>
          <button class="delete-project-btn">âœ–</button>
        </div>
      </div>
      <button class="add-project-btn">+ Add Project</button>
    </div>
  </div>

  <script>
    // ===== DOM Elements =====
    const previewPanel = document.getElementById("preview-panel");
    const resumeList = document.getElementById("resume-list");
    const createResumeBtn = document.getElementById("create-resume");
    let autosaveTimeout = null;

    // ===== Utilities =====
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        document.cookie.split(";").forEach((cookie) => {
          const c = cookie.trim();
          if (c.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(c.slice(name.length + 1));
          }
        });
      }
      return cookieValue;
    }

    function createEditableElement(tag, html = "", classes = []) {
      const el = document.createElement(tag);
      el.contentEditable = true;
      el.innerHTML = html;
      if (classes.length) el.classList.add(...classes);
      return el;
    }

    // ===== Save Resume =====
    function saveCurrentResume() {
      if (!window.currentResumeId) return;
      const text = previewPanel.innerHTML;
      const activeCard = document.getElementById(
        `resume-${window.currentResumeId}`
      );
      const title = activeCard?.querySelector(".resume-title")?.innerText || "";

      fetch("/save_resume/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          resume_id: window.currentResumeId,
          text: text,
          title: title,
        }),
      });
    }

    function debouncedSave() {
      clearTimeout(autosaveTimeout);
      autosaveTimeout = setTimeout(saveCurrentResume, 500);
    }

    // ===== Load / Render Resumes =====
    function renderResumes(resumes) {
      resumeList.innerHTML = "";
      resumes.forEach((resume) => {
        const card = document.createElement("div");
        card.className =
          "resume-card" +
          (window.currentResumeId === resume.id ? " active" : "");
        card.id = `resume-${resume.id}`;
        card.innerHTML = `
      <h3 class="resume-title" contenteditable="true">${resume.title}</h3>
      <p class="meta">Last edited: ${resume.updated_at}</p>
      <button class="set-active">Set Active</button>
      <button class="delete-btn">ðŸ—‘ Delete</button>
    `;
        resumeList.appendChild(card);
      });
    }

    function loadResumes() {
      fetch("/get_resumes/")
        .then((res) => res.json())
        .then((data) => renderResumes(data.resumes));
    }

    // ===== Set Active Resume =====
    function setActiveResume(id) {
      fetch(`/get_resume/${id}/`)
        .then((res) => res.json())
        .then((data) => {
          previewPanel.innerHTML = data.text;
          window.currentResumeId = data.id;
          document
            .querySelectorAll(".resume-card")
            .forEach((c) => c.classList.remove("active"));
          const activeCard = document.getElementById(`resume-${id}`);
          if (activeCard) activeCard.classList.add("active");
        });
    }

    // ===== Section Movement =====
    function moveSection(section, direction) {
      const parent = section.parentNode;
      if (
        direction === "up" &&
        section.previousElementSibling?.classList.contains("section")
      ) {
        parent.insertBefore(section, section.previousElementSibling);
      } else if (
        direction === "down" &&
        section.nextElementSibling?.classList.contains("section")
      ) {
        parent.insertBefore(section.nextElementSibling, section);
      }
    }

    // ===== Delegated Event Handling =====
    previewPanel.addEventListener("click", (e) => {
      const section = e.target.closest(".section");

      // Move buttons
      if (e.target.classList.contains("move-up-btn"))
        moveSection(section, "up");
      if (e.target.classList.contains("move-down-btn"))
        moveSection(section, "down");

      // Add buttons
      if (e.target.classList.contains("add-job-btn")) {
        const item = createEditableElement(
          "div",
          `
      <p class="job-title">Job title @ company</p>
      <p class="job-meta">Location | Date 1 - Date 2</p>
      <ul><li>Describe responsibilities...</li></ul>
      <button class="delete-job-btn">âœ–</button>
    `,
          ["job"]
        );
        section.querySelector(".content").appendChild(item);
      }
      if (e.target.classList.contains("add-education-btn")) {
        const item = createEditableElement(
          "div",
          `
      <p class="degree">Degree, School</p>
      <p>Date 1 - Date 2</p>
      <button class="delete-education-btn">âœ–</button>
    `,
          ["education"]
        );
        section.querySelector(".content").appendChild(item);
      }
      if (e.target.classList.contains("add-skill-btn")) {
        const item = createEditableElement(
          "div",
          `
      <p><strong>Category:</strong></p>
      <p>Skills</p>
      <button class="delete-skill-btn">âœ–</button>
    `,
          ["skill-item"]
        );
        section.querySelector(".content").appendChild(item);
      }
      if (e.target.classList.contains("add-project-btn")) {
        const item = createEditableElement(
          "div",
          `
      <p><strong>Project title:</strong></p>
      <ul><li>Bullet point</li></ul>
      <button class="delete-project-btn">âœ–</button>
    `,
          ["project-item"]
        );
        section.querySelector(".content").appendChild(item);
      }

      // Delete buttons
      const deleteMapping = {
        "delete-job-btn": "job",
        "delete-education-btn": "education",
        "delete-skill-btn": "skill-item",
        "delete-project-btn": "project-item",
      };
      for (let cls in deleteMapping) {
        if (e.target.classList.contains(cls)) {
          e.target.closest(`.${deleteMapping[cls]}`)?.remove();
        }
      }

      // Save after any actionable button
      const actionable = [
        "move-up-btn",
        "move-down-btn",
        "add-job-btn",
        "add-education-btn",
        "add-skill-btn",
        "add-project-btn",
        "delete-job-btn",
        "delete-education-btn",
        "delete-skill-btn",
        "delete-project-btn",
      ];
      if (actionable.some((cls) => e.target.classList.contains(cls)))
        saveCurrentResume();
    });

    // ===== Preview Panel Input =====
    previewPanel.addEventListener("input", debouncedSave);

    // ===== Resume Card Input / Enter =====
    let titleAutosaveTimeout = null;

    resumeList.addEventListener("input", (e) => {
      if (e.target.classList.contains("resume-title")) {
        const card = e.target.closest(".resume-card");
        const resumeId = parseInt(card.id.replace("resume-", ""));
        const title = e.target.innerText;

        clearTimeout(titleAutosaveTimeout);
        titleAutosaveTimeout = setTimeout(() => {
          fetch("/save_resume/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({
              resume_id: resumeId,
              title: title,
              // only send text if you want to update the content too
            }),
          });

          // Optional: update preview panel if this is the active resume
          if (resumeId === window.currentResumeId) {
            saveCurrentResume(); // updates both title + content
          }
        }, 500);
      }
    });
    resumeList.addEventListener("keydown", (e) => {
      if (e.target.classList.contains("resume-title") && e.key === "Enter") {
        e.preventDefault();
        e.target.blur();
      }
    });

    // ===== Resume Card Clicks =====
    resumeList.addEventListener("click", (e) => {
      const card = e.target.closest(".resume-card");
      if (!card) return;
      const id = parseInt(card.id.replace("resume-", ""));
      if (e.target.classList.contains("set-active")) setActiveResume(id);
      if (e.target.classList.contains("delete-btn")) {
        if (!confirm("Are you sure you want to delete this resume?")) return;
        fetch("/delete_resume/", {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ resume_id: id }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              card.remove();
              if (window.currentResumeId === id) {
                previewPanel.innerHTML = "";
                window.currentResumeId = null;
              }
            }
          });
      }
    });

    // ===== Create Resume =====
    createResumeBtn.addEventListener("click", () => {
      const newTemplate = document.getElementById("resume-template").innerHTML;
      const title = prompt(
        "Enter a title for your new resume:",
        "Untitled Resume"
      );
      fetch("/create_resume/", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ text: newTemplate, title: title }),
      })
        .then((res) => res.json())
        .then((data) => {
          previewPanel.innerHTML = data.text;
          window.currentResumeId = data.resume_id;
          loadResumes();
        });
    });

    // ===== Initial Load =====
    document.addEventListener("DOMContentLoaded", loadResumes);
  </script>
  {% endblock %}
</div>
